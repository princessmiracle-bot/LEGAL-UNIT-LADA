<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard Program | Unit Undang-Undang</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:'Inter',sans-serif}
body{margin:0;background:#f4f7fb;color:#333}

/* HEADER */
header{
  background:#fff;padding:16px 40px;
  display:flex;justify-content:space-between;align-items:center;
  box-shadow:0 4px 20px rgba(0,0,0,.06)
}
header h1{margin:0;font-size:18px;color:#2f66d4}
header button{
  background:#e74c3c;color:#fff;border:none;
  padding:10px 18px;border-radius:12px;font-size:13px;cursor:pointer
}

/* LAYOUT */
.container{max-width:1600px;margin:30px auto;padding:0 20px;display:flex;gap:24px}
.main-content{flex:3}
.side-content{flex:1;position:sticky;top:30px}

/* TOP BAR */
.top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.top-bar h3{margin:0;font-size:16px}
.top-bar p{margin:4px 0 0;font-size:12px;color:#666}
.top-bar button{
  background:linear-gradient(135deg,#4f8cff,#2f66d4);
  color:#fff;border:none;padding:12px 20px;
  border-radius:14px;font-size:13px;cursor:pointer;
  box-shadow:0 10px 25px rgba(47,102,212,.35);
  margin-left:8px
}

/* SEARCH */
.search-wrapper{display:flex;gap:8px;margin-bottom:16px}
.search-wrapper input{
  flex:1;padding:10px;border-radius:10px;
  border:1px solid #ddd;font-size:13px
}
.search-wrapper button{
  border:none;background:#ccc;
  padding:10px 14px;border-radius:10px;cursor:pointer
}

/* CARDS */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:20px}
.card{background:#fff;border-radius:18px;padding:22px;box-shadow:0 15px 35px rgba(0,0,0,.08)}
.section-title{font-size:15px;font-weight:600;margin-bottom:12px}

/* TABLE */
.table-wrapper{background:#fff;border-radius:18px;overflow:auto;box-shadow:0 18px 40px rgba(0,0,0,.08)}
table{width:100%;border-collapse:collapse}
th,td{padding:14px;font-size:13px}
th{background:#f1f4fb}
tr:not(:last-child){border-bottom:1px solid #eee}

/* ROW STATUS */
tr.belum{background:#fff5f5}
tr.proses{background:#fffdf2}
tr.selesai{background:#f3fff3}

/* BUTTON */
.action-btn{border:none;padding:6px 12px;border-radius:10px;font-size:12px;cursor:pointer}
.edit{background:#f1c40f}
.delete{background:#e74c3c;color:#fff}

/* REMINDER */
.reminder{
  background:linear-gradient(135deg,#fff4d6,#ffeaa7);
  border-radius:18px;padding:20px;
  box-shadow:0 15px 35px rgba(0,0,0,.1)
}
.reminder-item{
  background:#fff;padding:10px;border-radius:12px;
  margin-bottom:10px;cursor:pointer
}
.reminder-item:hover{background:#fff3c4}
.reminder-item small{font-size:12px;color:#7a5c00}
.hari-lagi{display:block;font-size:12px;margin-top:6px;color:#7a5c00}

/* BADGE */
.badge{
  display:inline-block;padding:4px 10px;
  border-radius:20px;font-size:11px;font-weight:600;cursor:pointer
}
.belum{background:#ffcccc;color:#a80000}
.proses{background:#fff3b0;color:#8a6d00}
.selesai{background:#d4f8d4;color:#0a7a0a}

/* HIGHLIGHT */
mark{background:#ffe066;padding:2px;border-radius:4px}
</style>
</head>

<body>

<header>
  <h1>Admin Dashboard Program</h1>
  <button onclick="logout()">Logout</button>
</header>

<div class="container">

<div class="main-content">

<div class="top-bar">
  <div>
    <h3>Pengurusan Program</h3>
    <p>Unit Undang-Undang</p>
  </div>
  <div>
    <button onclick="tambahProgram()">+ Tambah Program</button>
    <button onclick="exportExcel()">üì• Backup Excel</button>
  </div>
</div>

<div class="search-wrapper">
  <input type="text" id="searchInput" placeholder="Cari perkara, jenis, PIC, status, tarikh...">
  <button onclick="clearSearch()">‚ùå</button>
</div>

<div class="cards">
  <div class="card">
    <div class="section-title">Hari Ini</div>
    <div id="todayCard">Tiada</div>
  </div>
  <div class="card">
    <div class="section-title">Akan Datang</div>
    <div id="upcomingCard">Tiada</div>
  </div>
</div>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>No</th>
<th>Jenis</th>
<th>Tarikh</th>
<th>Perkara</th>
<th>PIC / Lokasi</th>
<th>Status</th>
<th>Tindakan</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<div class="side-content">
<div class="reminder">
<div class="section-title">üìå Maklum Balas (Belum Selesai)</div>
<div id="reminderCard">Tiada</div>
</div>
</div>

</div>

<script>
let data = JSON.parse(localStorage.getItem("programUU")) || [];
const tbody = document.getElementById("tbody");
const searchInput = document.getElementById("searchInput");

searchInput.addEventListener("input", renderAll);

function clearSearch(){
  searchInput.value="";
  renderAll();
}

function highlight(text, keyword){
  if(!keyword) return text;
  const reg = new RegExp(`(${keyword})`,"gi");
  return text.replace(reg,"<mark>$1</mark>");
}

function renderAll(){
  const keyword = searchInput.value.toLowerCase();
  const filtered = data.filter(p=>{
    return !keyword ||
      p.perkara?.toLowerCase().includes(keyword) ||
      p.jenis?.toLowerCase().includes(keyword) ||
      p.pic?.toLowerCase().includes(keyword) ||
      p.status?.toLowerCase().includes(keyword) ||
      p.tarikhEvent?.includes(keyword);
  });
  renderTable(filtered, keyword);
  renderCards();
  renderReminder();
}

function renderTable(list, keyword){
  tbody.innerHTML="";
  if(!list.length){
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center">Tiada rekod</td></tr>`;
    return;
  }

  list.forEach((p,i)=>{
    const statusClass =
      p.status==="Selesai"?"selesai":
      p.status==="Dalam Proses"?"proses":"belum";

    tbody.innerHTML += `
    <tr class="${statusClass}">
      <td>${p.bil || i+1}</td>
      <td>${highlight(p.jenis||"",keyword)}</td>
      <td>${highlight(p.tarikhEvent||"",keyword)}</td>
      <td>${highlight(p.perkara||"",keyword)}</td>
      <td>${highlight(p.tempat||p.pic||"",keyword)}</td>
      <td>
        <select onchange="updateStatus(${i},this.value)">
          <option ${p.status==="Belum"?"selected":""}>Belum</option>
          <option ${p.status==="Dalam Proses"?"selected":""}>Dalam Proses</option>
          <option ${p.status==="Selesai"?"selected":""}>Selesai</option>
        </select><br>
        <span class="badge ${statusClass}" onclick="toggleStatus(${i})">${p.status||"Belum"}</span>
      </td>
      <td>
        <button class="action-btn edit" onclick="editProgram(${i})">Edit</button>
        <button class="action-btn delete" onclick="padamProgram(${i})">Padam</button>
      </td>
    </tr>`;
  });
}

function updateStatus(i,status){
  if(status==="Selesai" && !confirm("Tandakan sebagai Selesai?")) return;
  data[i].status=status;
  localStorage.setItem("programUU",JSON.stringify(data));
  renderAll();
}

function toggleStatus(i){
  const order=["Belum","Dalam Proses","Selesai"];
  const next=order[(order.indexOf(data[i].status||"Belum")+1)%3];
  updateStatus(i,next);
}

function renderCards(){
  const today=new Date().toISOString().slice(0,10);
  document.getElementById("todayCard").innerHTML =
    data.filter(p=>p.tarikhEvent===today && p.jenis!=="Maklum Balas")
        .map(p=>p.perkara).join("<br>") || "Tiada";

  document.getElementById("upcomingCard").innerHTML =
    data.filter(p=>p.tarikhEvent>today && p.jenis!=="Maklum Balas")
        .map(p=>p.perkara).join("<br>") || "Tiada";
}

function renderReminder(){
  const reminderBox = document.getElementById("reminderCard");
  const reminder = data
    .filter(p => p.jenis==="Maklum Balas" && p.status!=="Selesai");
  const todayDate = new Date();

  reminderBox.innerHTML = reminder.length ? "" : "Tiada";

  function kiraHariLagi(tarikh){
    if(!tarikh) return null;
    const due = new Date(tarikh);
    return Math.ceil((due - todayDate)/(1000*60*60*24));
  }

  // Tambah property 'hariLagi' untuk sort
  reminder.forEach(p => p.hariLagi = kiraHariLagi(p.tarikhEvent));

  // Sort dari paling hampir / lewat ke jauh
  reminder.sort((a,b)=>{
    if(a.hariLagi===null) return 1;
    if(b.hariLagi===null) return -1;
    return a.hariLagi - b.hariLagi;
  });

  reminder.forEach((p, i) => {
    const hari = p.hariLagi;
    let statusClass = "belum";
    let teksHari = "Tarikh belum ditetapkan";

    if(hari !== null){
      if(hari < 0){
        statusClass = "belum";
        teksHari = `‚ùó Lewat ${Math.abs(hari)} hari`;
      } else if(hari <= 7){
        statusClass = "proses";
        teksHari = `‚è≥ ${hari} hari lagi`;
      } else {
        statusClass = "proses";
        teksHari = `üìÖ ${hari} hari lagi`;
      }
    }

    reminderBox.innerHTML += `
      <div class="reminder-item">
        <b>${p.perkara}</b><br>
        <small>PIC: ${p.pic || "-"}</small><br>
        <small>Tarikh Serahan: ${p.tarikhEvent || "-"}</small>
        <div class="hari-lagi">${teksHari}</div>
        <span class="badge ${statusClass}">${p.status || "Belum"}</span>
      </div>`;
  });
}

function tambahProgram(){ location.href="admin-formprogram.html"; }
function editProgram(i){
  localStorage.setItem("editIndex",i);
  location.href="admin-formprogram.html";
}
function padamProgram(i){
  if(confirm("Padam rekod?")){
    data.splice(i,1);
    localStorage.setItem("programUU",JSON.stringify(data));
    renderAll();
  }
}
function logout(){ location.href="user-dashboard.html"; }

function exportExcel(){
  let csv="Bil,Jenis,Tarikh,Perkara,PIC,Status\n";
  data.forEach(p=>{
    csv += `${p.bil||""},${p.jenis||""},${p.tarikhEvent||""},${p.perkara||""},${p.pic||""},${p.status||""}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="backup_program.csv";
  a.click();
}

renderAll();
</script>

</body>
</html>
